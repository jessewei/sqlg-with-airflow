<?xml version="1.0"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"  version="1.0">
<xsl:output method="xml" encoding="UTF-8" omit-xml-declaration="yes" indent="yes" />
<!--    / Preparation  /   -->
    <xsl:variable name='nl'><xsl:text>&#xa;</xsl:text></xsl:variable>
    <xsl:preserve-space elements="*"/>
<xsl:variable name="delim" select="','" />
<xsl:variable name="quote">"</xsl:variable>

<!--    / Template Start/-->
<xsl:template match="/">
<xsl:text>
# -*- coding: utf-8 -*-
# Author        : Jesse Wei
# LastUpdate    : 2018/08/04
# Impact        : Jobs generated by SQLG
# Message       : Humanity towards others, we live by sharing. Fear can hold you prisoner, only hope can set you free.

# from __future__ import print_function
import logging
import airflow
from datetime import datetime, timedelta
from airflow.operators.sensors import ExternalTaskSensor
from airflow.operators.python_operator import PythonOperator
from airflow import models
from airflow.models import Variable

from acme.operators.dwh_operators import PostgresOperatorWithTemplatedParams


DB_NAME = 'DWH'

</xsl:text>
<xsl:for-each select="Table/Row">
<xsl:value-of select="concat('my_taskid = ',$quote, JOB_NAME, $quote, $nl)" />
<xsl:value-of select="concat(JOB_NAME, ' = PostgresOperatorWithTemplatedParams(')" />
    task_id=my_taskid,
    postgres_conn_id='postgres_dwh',
    sql=DB_NAME + '/' + my_taskid + '/' + my_taskid + '.sql',
    parameters={"window_start_date": "{{ ds }}", "window_end_date": "{{ tomorrow_ds }}"},
    start_date=airflow.utils.dates.days_ago(7),
    pool='postgres_dwh')
<xsl:choose>
    <xsl:when  test="JOB_TYPE='TGL-CR'">
        <xsl:call-template name="TGL-EXEC">        
            <xsl:with-param name="schedName"> <xsl:value-of select="STD_FLOW_NAME" /> </xsl:with-param>
            <xsl:with-param name="shName">/home/tws/ods_batch_home/esp.batch.scripts/gen.report.sh</xsl:with-param>
            <xsl:with-param name="jobDesc">DESCRIPTION "generate the report file for batch"</xsl:with-param>
         </xsl:call-template>
    </xsl:when>
    <xsl:when  test="JOB_TYPE='TGL-CF'">
        <xsl:call-template name="TGL-EXEC">
            <xsl:with-param name="schedName"> <xsl:value-of select="STD_FLOW_NAME" /> </xsl:with-param>
            <xsl:with-param name="shName">/home/tws/ods_batch_home/esp.batch.scripts/archiving.file.sh</xsl:with-param>
            <xsl:with-param name="jobDesc">DESCRIPTION "archiving file for batch"</xsl:with-param>
         </xsl:call-template>
    </xsl:when>
    <xsl:when  test="JOB_TYPE='TGL-ML'">
        <xsl:call-template name="TGL-EXEC">
            <xsl:with-param name="schedName"> <xsl:value-of select="STD_FLOW_NAME" /> </xsl:with-param>
            <xsl:with-param name="shName">/home/tws/ods_batch_home/esp.batch.scripts/send.email.sh</xsl:with-param>
            <xsl:with-param name="jobDesc">DESCRIPTION "email and attachments for batch"</xsl:with-param>
         </xsl:call-template>
    </xsl:when>
    <xsl:when  test="JOB_TYPE='TGL-ZP'">
        <xsl:call-template name="TGL-EXEC">
            <xsl:with-param name="schedName"> <xsl:value-of select="STD_FLOW_NAME" /> </xsl:with-param>
            <xsl:with-param name="shName">/home/tws/ods_batch_home/esp.batch.scripts/zip.files.sh</xsl:with-param>
            <xsl:with-param name="jobDesc">DESCRIPTION "zip files for batch"</xsl:with-param>
         </xsl:call-template>
    </xsl:when>    
    <xsl:when  test="JOB_TYPE='TGL-EX'">
        <xsl:call-template name="TGL-EXEC">
            <xsl:with-param name="schedName"> <xsl:value-of select="STD_FLOW_NAME" /> </xsl:with-param>
            <xsl:with-param name="shName">/home/tws/ods_batch_home/esp.batch.scripts/gen.table2File.sh</xsl:with-param>
            <xsl:with-param name="jobDesc">DESCRIPTION "CSV Export for batch"</xsl:with-param>
         </xsl:call-template>
    </xsl:when>    
    <xsl:when  test="JOB_TYPE='TGL-IM'">
        <xsl:call-template name="TGL-EXEC">
            <xsl:with-param name="schedName"> <xsl:value-of select="STD_FLOW_NAME" /> </xsl:with-param>
            <xsl:with-param name="shName">/home/tws/ods_batch_home/esp.batch.scripts/import.file.sh</xsl:with-param>
            <xsl:with-param name="jobDesc">DESCRIPTION "Import for batch"</xsl:with-param>
         </xsl:call-template>
    </xsl:when>    
    <xsl:when  test="JOB_TYPE='TGL-FP'">
        <xsl:call-template name="TGL-EXEC">
            <xsl:with-param name="schedName"> <xsl:value-of select="STD_FLOW_NAME" /> </xsl:with-param>
            <xsl:with-param name="shName">/home/tws/ods_batch_home/esp.batch.scripts/ftp.files.sh</xsl:with-param>
            <xsl:with-param name="jobDesc">DESCRIPTION "Ftp files for batch"</xsl:with-param>
         </xsl:call-template>
    </xsl:when>      
    <xsl:when  test="JOB_TYPE='TGL-CM'">
        <xsl:call-template name="TGL-EXEC">
            <xsl:with-param name="schedName"> <xsl:value-of select="STD_FLOW_NAME" /> </xsl:with-param>
            <xsl:with-param name="shName">/home/tws/ods_batch_home/esp.batch.scripts/run.cmd.sh</xsl:with-param>
            <xsl:with-param name="jobDesc">DESCRIPTION "Common Shell Template"</xsl:with-param>
         </xsl:call-template>
    </xsl:when>       
    <xsl:when  test="JOB_TYPE='TGL-BT'">
        <xsl:call-template name="TGL-BATCH">
            <xsl:with-param name="schedName"> <xsl:value-of select="STD_FLOW_NAME" /> </xsl:with-param>
            <xsl:with-param name="shName">/home/tws/ods_batch_home/esp.batch.scripts/run.script.wrapper.sh</xsl:with-param>
            <xsl:with-param name="jobDesc">DESCRIPTION "Common Remote Batch Template"</xsl:with-param>
            <xsl:with-param name="JobParam" select="JB_PARMS" />
         </xsl:call-template>
    </xsl:when>   
    <xsl:when  test="JOB_TYPE='EXE'">
        <xsl:call-template name="EXE">
            <xsl:with-param name="schedName"> <xsl:value-of select="STD_FLOW_NAME" /> </xsl:with-param>
            <xsl:with-param name="shName">/home/tws/ods_batch_home/esp.batch.scripts/run.script.wrapper.sh</xsl:with-param>
            <xsl:with-param name="jobDesc">DESCRIPTION "Common Local Batch Template"</xsl:with-param>
            <xsl:with-param name="JobParam"> <xsl:value-of select="PRCS_INFO" /> </xsl:with-param>
         </xsl:call-template> 

    </xsl:when>    
    <xsl:when  test="JOB_TYPE='WATCH'">
        <xsl:call-template name="EXE-DUMMY">
            <xsl:with-param name="schedName"> <xsl:value-of select="STD_FLOW_NAME" /> </xsl:with-param>
            <xsl:with-param name="shName">/home/tws/ods_batch_home/esp.batch.scripts/run.script.wrapper.sh</xsl:with-param>
            <xsl:with-param name="jobDesc">DESCRIPTION "Common Remote Batch Template"</xsl:with-param>
            <xsl:with-param name="JobParam" select="JB_PARMS" />
         </xsl:call-template>
    </xsl:when>      
    <xsl:when  test="JOB_TYPE='SQL'">
        <xsl:call-template name="DW-MAIN">
            <xsl:with-param name="JobParam" select="JB_PARMS" />        
        </xsl:call-template>            
    </xsl:when>       
    <xsl:otherwise>    <!-- DB:: DW-MAIN'-->
        <xsl:call-template name="DW-MAIN">
            <xsl:with-param name="JobParam" select="JB_PARMS" />        
        </xsl:call-template>            
    </xsl:otherwise>
</xsl:choose>

    
</xsl:for-each> 
</xsl:template>


<!--    / Template lib by jsd template, job type  /   -->
<xsl:template name="EXE">
 <xsl:param name="schedName" /> 
 <xsl:param name="shName" />
 <xsl:param name="jobDesc" />
 <xsl:param name="JobParam" />
 <jsdl:jobDefinition xmlns:XMLSchema="http://www.w3.org/2001/XMLSchema" xmlns:jsdl="http://www.ibm.com/xmlns/prod/scheduling/1.0/jsdl" xmlns:jsdle="http://www.ibm.com/xmlns/prod/scheduling/1.0/jsdle"  XMLSchema:text="resolveVariableTable" name="executable">
 <xsl:element name='jsdl:application'><xsl:attribute name='name'>executable</xsl:attribute>
    <xsl:element name='jsdle:executable'><xsl:attribute name='interactive'>false</xsl:attribute> <xsl:attribute name='workingDirectory'>/home/tws/ods_batch_home/etl/</xsl:attribute>
        <xsl:value-of select="$nl"/>        
        <xsl:value-of select="$nl"/>        
        <xsl:element name='jsdle:script'><xsl:value-of select="$JobParam"/></xsl:element>
    </xsl:element>
 </xsl:element>
</jsdl:jobDefinition>  
<xsl:value-of select="concat($nl,$jobDesc)"/>
</xsl:template>

<xsl:template name="EXE-DUMMY">
 <xsl:param name="schedName" /> 
 <xsl:param name="shName" />
 <xsl:param name="jobDesc" />
 <jsdl:jobDefinition xmlns:XMLSchema="http://www.w3.org/2001/XMLSchema" xmlns:jsdl="http://www.ibm.com/xmlns/prod/scheduling/1.0/jsdl" xmlns:jsdle="http://www.ibm.com/xmlns/prod/scheduling/1.0/jsdle"  XMLSchema:text="resolveVariableTable" name="executable">
 <xsl:element name='jsdl:application'><xsl:attribute name='name'>executable</xsl:attribute>
    <xsl:element name='jsdle:executable'><xsl:attribute name='interactive'>false</xsl:attribute>
        <xsl:value-of select="$nl"/>        
        <jsdle:script>date</jsdle:script>
    </xsl:element>
 </xsl:element>
</jsdl:jobDefinition>  
<xsl:value-of select="concat($nl,$jobDesc)"/>
</xsl:template>

<xsl:template name="TGL-EXEC">
 <xsl:param name="schedName" /> 
 <xsl:param name="shName" />
 <xsl:param name="jobDesc" />
 <jsdl:jobDefinition xmlns:XMLSchema="http://www.w3.org/2001/XMLSchema" xmlns:jsdl="http://www.ibm.com/xmlns/prod/scheduling/1.0/jsdl" xmlns:jsdle="http://www.ibm.com/xmlns/prod/scheduling/1.0/jsdle"  XMLSchema:text="resolveVariableTable" name="executable">
 <xsl:element name='jsdl:application'><xsl:attribute name='name'>executable</xsl:attribute>
    <xsl:element name='jsdle:executable'><xsl:attribute name='interactive'>false</xsl:attribute>
        <xsl:attribute name='path'><xsl:value-of select="$shName"/></xsl:attribute>
        <xsl:attribute name='workingDirectory'>/home/tws/ods_batch_home/esp.batch.scripts</xsl:attribute>
            <xsl:value-of select="$nl"/>        
            <xsl:element name='jsdle:arguments'>
                <xsl:element name='jsdle:value'><xsl:value-of select="$schedName"/></xsl:element>
                <xsl:element name='jsdle:value'>${tws.job.name}</xsl:element>
                <xsl:element name='jsdle:value'>^END_DT_CHAR^</xsl:element>
            </xsl:element>
     </xsl:element>
  </xsl:element>
</jsdl:jobDefinition>  
<xsl:value-of select="concat($nl,$jobDesc)"/>
</xsl:template>

<xsl:template name="TGL-BATCH">
 <xsl:param name="schedName" /> 
 <xsl:param name="shName" />
 <xsl:param name="jobDesc" />
 <xsl:param name="JobParam" />
 <jsdl:jobDefinition xmlns:XMLSchema="http://www.w3.org/2001/XMLSchema" xmlns:jsdl="http://www.ibm.com/xmlns/prod/scheduling/1.0/jsdl" xmlns:jsdle="http://www.ibm.com/xmlns/prod/scheduling/1.0/jsdle"  XMLSchema:text="resolveVariableTable" name="executable">
 <xsl:element name='jsdl:application'><xsl:attribute name='name'>executable</xsl:attribute>
    <xsl:element name='jsdle:executable'><xsl:attribute name='interactive'>false</xsl:attribute>
        <xsl:attribute name='path'><xsl:value-of select="$shName"/></xsl:attribute>
        <xsl:attribute name='workingDirectory'>/home/tws/ods_batch_home/esp.batch.scripts</xsl:attribute>
        <xsl:value-of select="$nl"/>
        <xsl:if test="string-length($JobParam)!=0">
            <xsl:element name='jsdle:arguments'>        
                <xsl:for-each select="$JobParam//item"> 
                        <jsdle:value>
                        <xsl:value-of select="." />
                        </jsdle:value>
                </xsl:for-each>             
            </xsl:element>
        </xsl:if>            
    </xsl:element>
  </xsl:element>
</jsdl:jobDefinition>  
<xsl:value-of select="concat($nl,$jobDesc)"/>
</xsl:template>

<xsl:template name="DW-MAIN">
<xsl:param name="JobParam" />
<xsl:value-of select="$nl"/>    
<xsl:value-of select="$nl"/>   

</xsl:template>
 
</xsl:stylesheet>